pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

-- All colliders are axis-aligned bounding boxes (AABBs)
-- All collider positions, widths, and heights are integer numbers
-- Except for special circumstances, Actors and Solids will never overlap
-- Solids do not interact with other Solids

function create_player(x, y)
    return {
        x = x,
        y = y,
        spd={x=0, y=0},
        k = 2,
        hitbox = {x=0, y=0, w=8, h=8},
        move = function(self, dx, dy)
            self.x = self.x + dx
            self.y = self.y + dy
        end,
        draw = function(self)
            spr(self.k, self.x, self.y)
        end,
        on_collide = function(self, b)
        end
    }
end

function create_obs(x, y)
    return {
        x = x,
        y = y,
        k = 1,
        hitbox = {x=2, y=2, w=4, h=4},
        move = function(self, dx, dy)
            self.x = self.x + dx
            self.y = self.y + dy
        end,
        draw = function(self)
            spr(self.k, self.x, self.y)
        end
    }
end

function collide(a, b, dx, dy)
    -- if a_min > b_max then
    --     return false
    -- end
    -- if a_max < b_min then
    --     return false
    -- end

    if b.x+b.hitbox.x+b.hitbox.w > a.x+a.hitbox.x+dx and 
        b.y+b.hitbox.y+b.hitbox.h > a.y+a.hitbox.y+dy and
        b.x+b.hitbox.x < a.x+a.hitbox.x+a.hitbox.w+dx and 
        b.y+b.hitbox.y < a.y+a.hitbox.y+a.hitbox.h+dy then
        return b
    end
    return nil
end

function load_room()
    for x=1,15 do
        for y=1,15 do
            local tile = mget(x, y)
            if tile == 1 then
                add(obstacles, create_obs(x*8, y*8))
            end
        end
    end

    -- debug=#obstacles
end

function _init()
    obstacles = {}
    player = create_player(2, 3)

    load_room()
end

function _update()
    local dir = {0, 0}

    if (btn(0)) dir[1] = -1
    if (btn(1)) dir[1] = 1
    if (btn(2)) dir[2] = -1
    if (btn(3)) dir[2] = 1

    v = 1

    collided = false
    for obs in all(obstacles) do
        if collide(player, obs, dir[1] * v, dir[2] * v) then
            collided = true
            player:on_collide(obs)
        end
    end

    if (not collided) player:move(dir[1] * v, dir[2] * v)
end

function _draw()
    cls()

    map()

    player:draw()
end
__gfx__
00000000ddddddddeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d111111de111111e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700d111111de1e11e1e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000d11dd11de111111e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000d11dd11de1eeee1e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700d111111de11ee11e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d111111de111111e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ddddddddeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101001101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101001101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1001101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101001101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010100110101010101010100110101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010011010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010100110101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
